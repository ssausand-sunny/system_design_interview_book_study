## Intro
#### 뉴스피드란?

뉴스 피드는 웹사이트나 애플리케이션을 통해 사용자에게 최신 뉴스나 업데이트된 콘텐츠를 제공하는 기능을
의미합니다. 일반적으로 소셜 미디어 플랫폼, 뉴스 사이트, 블로그 등에서 뉴스 피드를 제공하며, 사용자가 관심을 
가질 만한 다양한 정보들을 시간 순서대로 보여줍니다.

---

## 전제
본 책은 가상 면접을 바탕으로 요구사항을 정해두고 이에 기반한 시스템을 설계한다. 클라이언트의 요구사항은 아래와 같다.

- 모바일, 웹 모두 지원해야 한다. 
- 사용자는 뉴스 피드 페이지에 새로운 스토리를 올릴 수 있고, 친구들이 올리는 스토리를 볼 수 있어야 한다.
- 피드에 보여지는 순서는 특별한 기준이 없이 시간 역순으로 보여준다.
- 사용자는 최대 5000명의 친구를 가질 수 있다.
- 매일 천만명이 방문하는 사이트를 설계해야 한다. ( 10 million DAU )
- 피드에는 이미지 및 비디오등의 미디어 파일이 포함 될 수 있다.

자 그럼 이제부터 6가지의 요구사항을 바탕으로 피드 서비스를 설계해 보자 !

---  

## 개략적인 설계안

뉴스피드 서비스는 크게 두가지로 구분된다.
1. 피드 발행    
    사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 저장하고, 친구들의 뉴스 피드에 전송한다.
2. 뉴스 피드 생성    
    모든 친구의 포스팅을 시간 역순으로 보여준다.

단순하게 생각한다면, 피드발행은 POST 메소드를 통해 생성하고 데이터베이스에 저장하고, 
뉴스 피드 생성은 GET 메소드를 통해 가져오면 된다. 추가적으로 이전장에서 학습한 알림서비스를 추가한다면, 알림기능을 추가할수도 있을 것이다.

---

## 상세 설계

### 포스팅 전송 서비스 (팬 아웃 서비스)
팬아웃은 어떤 사용자가 그 사용자의 친구관계에 있는 모든 사용자에게 피드를 전달하는 과정을 말한다.    
팬아웃에는 두가지 모델이 존재하는데, 하나는 쓰기시점에 시행하는 (fanout-on-write, push) 모델이고
, 다른하나는 읽기 시점에 시행하는 (fanout-on-read, pull) 모델이다. 

두가지 모델의 특징은 다음과 같다.

#### fanout-on-write

- 피드가 실시간으로 갱신되며, 친구 목록에 있는 사용자에게 즉시 전송된다.     
- 포스팅이 쓰여진 순간에 갱신되기 때문에 피드를 읽는 시간이 짧아진다.    
- 친구가 많은 사용자의 경우, 친구 목록을 가져오고 그 목록의 사용자의 피드를 갱신하는 시간이 오래 걸릴 수 있다.(hotkey 문제)     
   특히, 사용자의 친구가 접속률이 저조하다면 컴퓨팅 자원의 낭비가 될 수 있다.
    

#### fanout-on-read    

- 비활성 사용자, 로그인을 거의 하지 않는 사용자의 경우 컴퓨팅 자원을 아낄 수 있다.
- 데이터를 push하는 작업이 없기 때문에 hotkey문제도 발생하지 않는다.
- 피드를 주기적으로 읽어야 하기 때문에 많은 시간이 소요 될 수 있다.


본 책에서는 두가지 방법을 결합한 하이브리드 방식을 이용하여 친구가 적은 사용자에게는 push 모델을, 친구가 많은 사용자에게는 pull 모델을 적용시켜 장점만을 취하고자 한다.

팬아웃 서비스는 다음과 같이 동작한다.

1. 그래프 데이터베이스를 통해 친구 ID 조회
2. 사용자 정보 캐시에서 친구 정보 조회
3. 친구 목록과 포스팅 ID를 메시지 큐에 입력
4. 팬아웃 작업 서버에서 메시지 큐에서 하나씩 꺼내서 뉴스 피드 캐시에 저장한다.


![image](https://github.com/user-attachments/assets/63c96e45-1ab4-40ac-b591-a6ef384c4e01)


---

### 피드 읽기 흐름 설계

1. 피드 서비스에서 포스팅 ID를 가져온다.
2. 피드에 표시할 사용자 이름, 사진, 컨텐츠, 이미즈등을 가져와 완전한 컨텐츠를 생성한다.
3. 생성된 피드를 JSON형태로 반환하여 클라이언트에게 전송한다.

![image](https://github.com/user-attachments/assets/6f192bc2-78ca-4678-b03a-85a5b40ece93)


---

### 캐시구조

피드 서비스의 주요 항목인 피드 발행과 피드 읽기만 하더라도 여러개의 캐시가 사용되는 것을 확인할 수 있다. 그 만큼 뉴스 피드 서비스에서는 캐시가 중요하다.

본 설계안의 경우 다음과 같이 캐시를 5계층으로 분할하여 제공한다고 한다.

| 분류     | 항목                |
|--------|-------------------|
| 뉴스피드   | 뉴스피드              |
| 콘텐츠    | 인기 콘텐츠, 일반 콘텐츠    |
| 소셜 그래프 | 팔로어, 팔로잉          |
| 행동     | '좋아요', 답글, 기타     |
| 횟수     | 좋아요 횟수, 답글 횟수, 기타 |

- ##### 뉴스피드    
  뉴스피드의 ID를 저장한다.    
- ##### 콘텐츠    
  인기 콘텐츠, 일반 콘텐츠의 포스팅을 저장한다. 인기 콘텐츠의 경우 좀더 긴 시간의 캐싱이 필요할 것이다.      
- ##### 소셜그래프    
  사용자간의 관계 정보를 보관한다.       
- ##### 행동    
  포스팅에 대한 사용자의 행위를 보관한다.      
- ##### 횟수    
  좋아요, 응답, 팔로워, 팔로윙, 조회수 등의 정보를 보관한다.      


---
## 마무리

다른 시스템 설계와 마찬가지로 클라이언트의 요구사항이 각자 다르기 때문에 설계하는 것에 정답은 없다. 
다만, 어떠한 결정을 지을때 그 배경에 trade-off 가 있음을 알고 설명할 수 있어야 한다.

이 외에도 이전에 나왔던 데이터베이스의 규모확장관련 이슈나, 데이터 센터, 캐싱전략등을 고려한다면 더욱 좋은 품질의 서비스를 설계할 수 있을 것이다.
