## 개요
유튜브와 같은 동영상 스트리밍 서비스는, 다음과 같은 다양한 기능을 지원합니다. 
+ 비디오 재생/업로드
+ 댓글남기기
+ 공유/좋아요 버튼
+ 해당 영상을 내 플레이리스트에 저장

하지만, 이러한 기능들을 모두 지원하는 서비스를 면접 상황에 설계하는 것은 어렵습니다. 짧은 면접 시간내에 면접관이 해당 서비스에서 가장 중요한 기능이 무엇이라고 생각하는지를 먼저 알아내야 합니다.

해당 장에서는 **비디오 업로드/스트리밍 기능**에 초점을 두고 설계를 시작하게 됩니다.
이에 더해서 중요하게 생각해야할 점은, **CDN 서비스를 이용하는데에 드는 비용**입니다. CDN과 같은 복잡한 서비스를 구축하면서 서비스 개발을 할 수 없기 때문에, AWS나 GCP와 같은 클라우드 서비스에서 제공하는 CDN 서비스를 사용해야하기 때문입니다.

일반적으로, 비디오 스트리밍을 위해서는 CDN이 필수적입니다. 예를 들어, 미국 서버에 존재하는 영상을 한국 서버에서 보게 된다면 서버 위치가 멀기 때문에 다운로드하는 시간이 오래 걸리게 됩니다. CDN은, 가까운 서버에 해당 영상을 캐싱해 빠르게 영상을 시청할 수 있도록 합니다.

능동적 사용자는 5백만명이고, 이 사용자들이 하루에 5개의 비디오를 본다고 가정 해 봅시다. 영상의 사이즈를 300MB로 제한해서 계산해보겠습니다.

5백만 \* 5개의 비디오 \* 0.3GB = 7500TB -> AWS가 제공하는 CDN은 1GB당 0.02\$이므로, 스트리밍을 위한 **CDN 비용만 150,000\$가 듭니다. (한화로 약 2억..)**

이러한 문제점이 있기 때문에, 인프라 비용을 최소화 시키는 것도 중요하게 생각해야 합니다.

이런 개요를 가지고, 설계 -> 상세설계 -> 최적화 순서로 글을 진행하겠습니다.

## 설계

개략적인 설계는 다음과 같습니다.

![](https://velog.velcdn.com/images/kjy0349/post/bfb3463a-89c7-461d-ab5b-4a8514c436dd/image.png)


비디오 스트리밍 요청은 모두 CDN 서버로 보내고, 동영상 업로드 링크 생성이나 피드 추천, 사용자 가입등은 API 서버가 처리하도록 해야 합니다. 위에서 비디오 업로드/스트리밍 기능에 집중해서 설계를 진행하자고 가정했기 때문에, 업로드와 스트리밍에 대해서 세부설계를 시작하겠습니다.

![](https://velog.velcdn.com/images/kjy0349/post/995734f7-7c35-416f-a5e8-3ebb160b0a13/image.png)


### 업로드
상세 설계는 다음과 같고, 프로세스는 a(비디오 업로드) b(메타데이터 갱신) 두개로 나뉩니다.


1. 비디오를 원본 저장소에 업로드 합니다.
2. 트랜스코딩 서버는 원본 저장소에서 업로드 된 비디오를 가져와 트랜스 코딩을 시작합니다.
3. 트랜스 코딩이 완료되면 두 절차가 병렬적으로 수행됩니다.
	+ 3a. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드합니다.
    + 3b. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
    	
        + 3a.1 트랜스코딩이 끝난 비디오를 CDN에 올립니다.
        + 3b.1 완료 핸들러가 이벤트 데이터를 큐에서 꺼냅니다.
        + 3b.1.a, 3b.1.b 완료 핸들러가 메타데이터 데이터베이스와 캐시를 갱신합니다.
4. API 서버가 단말에게 비디오 업로드가 끝났고, 스트리밍 준비가 완료되었음을 알립니다.

비디오 업로드와 메타 데이터 갱신은 위와 같이 진행됩니다.
책에서는, b 작업인 메타데이터 갱신이 상세설계 그림과 같이 사용자 단말부터 -> API 서버로 요청이 간다고 이야기하고 있습니다.

> 원본 저장소에 파일이 업로드되는 동안, **단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.** 이 요청에 포함된 메타데이터에는 파일 이름, 크기, 포맷등의 정보가 들어있다. API 서버는 이 정보로 메타데이터 캐시와 데이터 베이스를 업데이트 한다.  -255p-

하지만, 위의 과정에서 보면 트랜스 코딩 완료 핸들러가 해당 비디오의 메타데이터 캐시와 메타데이터 데이터베이스를 갱신하고 있습니다. 그렇다면 책에서 말하고 있는 클라이언트가 보내는 요청은무엇일까라는 의문이 들었습니다.

해당 부분에 대해서 찾아보니, 두 과정 모두가 필요하다는 것을 알게 되었습니다. 클라이언트가 처음 파일을 업로드할 때, 파일 이름, 용량이나 확장자와 같은 정보는 클라이언트가 바로 알고 있습니다. 따라서 해당 데이터를 기준으로 메타데이터를 갱신한다면, 빠르게 사용자에게 파일 상태에 대한 응답을 보낼 수 있게 됩니다.

트랜스 코딩과 같은 작업은 오래걸릴 수 있기 때문에, 사용자에게 전달할 데이터가 즉시 준비되지 않으므로 처음에는 클라이언트로부터 얻은 간단한 정보로 데이터를 갱신해두고 + 트랜스코딩 이후 적용 된 비디오 코덱 및 포맷, 트랜스코딩 이후의 파일 크기 등 추가 메타데이터를 갱신하게 됩니다.

### 스트리밍
비디오 스트리밍은 간단하게 말해 비디오를 서버로부터 다운로드 받아 재생하는 것을 말합니다. 비디오 스트리밍은 각 단말마다 다른 프로토콜을 사용해 이루어집니다.(일반적으로 MPEG, 애플은 HLS, 마이크로소프트의 MSS와 같이 다양한 프로토콜을 사용합니다.)

이러한 프로토콜의 차이에 따라, 각 프로토콜마다 지원하는 비디오 인코딩과 플레이어의 차이가 존재하게 됩니다. 따라서 비디오 스트리밍 서비스를 설계할 때에는 서비스에 맞는 프로토콜을 잘 골라야 합니다.

스트리밍은 업로드와 다르게, 각 사용자 단말(컴퓨터, 스마트폰, 스마트 TV)가 CDN 서버에 바로 다운로드 요청을 보냄으로써 간단하게 완료됩니다.

## 상세설계

### 비디오 트랜스코딩
가장 복잡한 부분입니다. 먼저, 사용자가 업로드한 원본 비디오는 용량이 굉장히 큽니다. 60 프레임으로 녹화딘 HD 비디오는 수백GB에 달합니다. 이런 비디오를 서버에 바로 올리게 되면 인프라 사용량이 너무 크기 때문에, 트랜스코딩을 통해 용량을 일정하게 줄여야 합니다.
또한, 사용자의 네트워크 대역폭은 모두 다르기 때문에 해당 대역폭에 맞는 화질로 비디오를 서비스해야 합니다.

이러한 여러 필요성에 의해 비디오 스트리밍 서비스에는 트랜스코딩을 도입해야 합니다.

일반적으로 트랜스코딩은 원본비디오를 **비디오, 오디오, 메타데이터** 세 부분으로 나누어 병렬적으로 처리합니다. 트랜스코딩의 전체적인 과정을 보겠습니다.

![](https://velog.velcdn.com/images/kjy0349/post/ae16228a-bf24-48a2-97a5-61a9e4421051/image.png)


각 부분은 다음과 같은 역할을 수행합니다.
1. 전처리기 : 비디오 분할, DAG 생성. 비디오 스트림을 GOP(Group of Pictures)라는 단위로 쪼개고, DAG(Directed Acyclic Graph : 유향 비순환 그래프) 모델을 생성합니다. 해당 모델은 위에서 언급했듯이 동영상 인코딩 작업을 비디오, 오디오, 메타데이터으로 나누어 병렬적으로 실행될 수 있게 하는 모델입니다.
마지막으로 이렇게 생성한 GOP와 메타데이터를 임시 저장소에 보관하고, 이를 캐싱합니다.

2. DAG 스케줄러 : DAG 그래프를 몇 단계로 분할한 후에, 작업 큐에 넣어줍니다.
![](https://velog.velcdn.com/images/kjy0349/post/04998fc5-183d-4b67-abdc-7500f51c5489/image.png)

위의 그림은 DAG 그래프를 2개의 단계로 쪼갠 형태입니다.

4. 자원 관리자 : DAG 그래프에서 할당한 작업들을, 각 작업 서버의 큐로 넣어주는 역할을 수행합니다. 비디오 인코딩, 워터마크, 썸네일과 같은 기능을 처리하는 서버로 요청을 보내줍니다.

5. 작업 실행 서버 : 위에서 할당 된 작업을 수행하는 서버입니다.

6. 임시 저장소 : 메타데이터, 비디오/오디오 데이터들을 임시로 저장하는 서버입니다. 캐싱이나 인코딩이 실패했을 때 다시 시도하기위해 동영상을 임시로 저장하는 역할을 수행합니다.

7. 인코딩 된 비디오 : 모든 처리가 완료 된 비디오입니다.


## 최적화

크게 최적화가 가능한 부분은 CDN, 전체적 구조 변경 두 부분입니다.

### CDN 최적화
먼저 개요에서도 언급했듯이 CDN은 굉장히 비싼 서비스입니다. 인프라 사용에 드는 비용을 줄이기위해 CDN에 최적화를 적용할 수 있습니다. 이는 비디오 스트리밍은 **롱테일 분포**를 따른다는 가정으로부터 시작할 수 있습니다. **인기 있는 비디오는 자주 재생되지만, 나머지는 거의 보는 사람이 없다**는 가정입니다. 이를 위해 모든 비디오를 업로드하는 순간 CDN 서버에 업로드하는 것이 아닌, **인기 있는 비디오만 CDN 서버에 업로드해 재생하게하고 다른 비디오는 비디오 서버를 통해 재생하게 하는 것**입니다.

이외에도, 어떤 비디오는 특정 지역에서만 인기가 높을 수 있습니다. 이러한 비디오는 해당 지역으로 옮겨 다른 지역에서의 CDN 사용량을 낮출 수 있습니다.
역시 가장 좋은것은, CDN을 직접 구축하고 ISP와 직접 제휴하는 것입니다. 하지만 CDN은 초대형 프로젝트 이므로 대규모 스트리밍 사업자만 해당됩니다.

### 전체적 구조 변경

![](https://velog.velcdn.com/images/kjy0349/post/f5861228-f189-44ce-a302-f3961b7c2001/image.png)

위에서 본 그림을 다시한 번 봅시다. 각 작업의 결과는, 다른 작업 프로세스의 입력이 됩니다. 즉 강한 결합도를 가지고 있습니다. 해당 그림에서는 트랜스 코딩 완료 부분에만 큐가 적용되어 있지만, 가능하다면 각 절차 사이에 모두 메세지 큐를 도입할 수 있습니다. 큐를 도입함으로써 각 서비스간 결합도가 줄어들고, 서비스 자체적으로 스케일 아웃이 가능해지기 때문에 빠른 응답속도를 얻을 수 있습니다.

이외에도 책에서는 여러 최적화 방안에 대해 언급하고 있지만, 여기까지만 서술하겠습니다.


## 마무리
유튜브와 같은 비디오 스트리밍 서버를 크게 **주의해야 할 사항 - 설계 - 상세설계 - 최적화** 순으로 설계를 진행했습니다. 해당 장을 통해 CDN 최적화 방법, 비디오 스트리밍에 필요한 여러 도메인 지식들을 알 수 있었습니다. 각 장을 읽어가면 갈수록 메세지큐를 사용하지 않는 대규모 서비스는 거의 없다는 생각이 듭니다. 결합도를 줄이는것과 동시에, 스케일 아웃을 용이하게하는 메세지큐는 역시 필수적인 것 같습니다. 최적화 부분이나, DAG에 관한 내용은 책에 더 자세하게 서술되어 있으므로 해당 내용을 참고하시면 되겠습니다. 긴 글 읽어주셔서 감사합니다!
